<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kravel.server.api.article.mapper.ReviewMapper">


    <select id="findReviewDetailImgById" parameterType="hashmap" resultType="rwImgDTO">
        SELECT
            tari.IMG_ID imgId,
            tari.IMG_URL imgUrl,
            tari.REPRESENT repesent
        FROM
            tb_article_review tar
            INNER JOIN
                tb_article_review_img tari
            ON tar.REVIEW_ID = tari.REVIEW_ID
        WHERE
            tar.ARTICLE_ID = #{param.articleId}
            AND tar.REVIEW_ID = #{param.reviewId}
            AND tar.USE_AT = "Y";
    </select>

    <select id="findReviewLikeCntById" parameterType="hashmap" resultType="articleReviewDTO">
        SELECT
            tar.REVIEW_ID reviewId,
            COUNT(trl.LIKE_ID) likeCnt,
            b.likeState likeState
        FROM
            tb_article_review tar
            LEFT JOIN
                tb_review_like trl
            ON tar.REVIEW_ID = trl.REVIEW_ID,
            (
                SELECT
                    COUNT(trl2.MEMBER_ID) likeState
                FROM
                    tb_article_review tar2
                    LEFT JOIN
                        tb_review_like trl2
                    ON tar2.REVIEW_ID = trl2.REVIEW_ID
                WHERE
                    trl2.REVIEW_ID = tar2.REVIEW_ID
                    AND trl2.MEMBER_ID = #{param.memberId}
                ) b
        WHERE
            tar.ARTICLE_ID = #{param.articleId}
            AND tar.REVIEW_ID = #{param.reviewId}
            AND tar.USE_AT = "Y";
    </select>
</mapper>